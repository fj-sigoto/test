<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>画像テキスト比較アプリ</title>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .image-container {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        .image-box {
            flex: 1;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 8px;
        }
        video, canvas, img {
            width: 100%;
            border-radius: 4px;
        }
        button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        button:disabled {
            background-color: #cccccc;
        }
        #results {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            text-align: left;
        }
        .matched {
            background-color: #e6ffe6;
            padding: 5px;
            margin: 5px 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>画像テキスト比較アプリ</h1>
    <div class="container">
        <div class="camera-container">
            <video id="video" autoplay playsinline></video>
        </div>
        
        <div>
            <button id="captureBtn">写真を撮影</button>
            <button id="compareBtn" disabled>テキストを比較</button>
            <button id="resetBtn">リセット</button>
        </div>
        
        <div class="image-container">
            <div class="image-box">
                <h3>画像 1</h3>
                <img id="photo1" alt="撮影した画像1">
                <div id="text1"></div>
            </div>
            <div class="image-box">
                <h3>画像 2</h3>
                <img id="photo2" alt="撮影した画像2">
                <div id="text2"></div>
            </div>
        </div>
        
        <div id="results">
            <h3>一致したテキスト:</h3>
            <div id="matchedText"></div>
        </div>
    </div>

    <!-- Tesseract.js のインポート -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/2.1.5/tesseract.min.js"></script>
    
    <script>
        // 変数の初期化
        let currentImageNum = 1;
        let capturedImages = {
            photo1: null,
            photo2: null
        };
        let extractedTexts = {
            text1: [],
            text2: []
        };
        
        // DOM要素
        const video = document.getElementById('video');
        const captureBtn = document.getElementById('captureBtn');
        const compareBtn = document.getElementById('compareBtn');
        const resetBtn = document.getElementById('resetBtn');
        const photo1 = document.getElementById('photo1');
        const photo2 = document.getElementById('photo2');
        const text1Div = document.getElementById('text1');
        const text2Div = document.getElementById('text2');
        const matchedTextDiv = document.getElementById('matchedText');

        // カメラを初期化
        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" },
                    audio: false 
                });
                video.srcObject = stream;
            } catch (err) {
                console.error("カメラへのアクセスに失敗しました:", err);
                alert("カメラへのアクセスに失敗しました。カメラの許可を確認してください。");
            }
        }

        // 画像をキャプチャ
        function captureImage() {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const imgData = canvas.toDataURL('image/png');
            
            if (currentImageNum === 1) {
                photo1.src = imgData;
                capturedImages.photo1 = imgData;
                text1Div.innerHTML = "<p>テキスト解析中...</p>";
                
                // 1枚目の画像からテキスト抽出
                extractText(imgData, 'text1');
                currentImageNum = 2;
            } else {
                photo2.src = imgData;
                capturedImages.photo2 = imgData;
                text2Div.innerHTML = "<p>テキスト解析中...</p>";
                
                // 2枚目の画像からテキスト抽出
                extractText(imgData, 'text2');
                
                // 比較ボタンを有効化
                captureBtn.disabled = true;
                compareBtn.disabled = false;
            }
        }

        // テキスト抽出
        function extractText(imageData, textId) {
            Tesseract.recognize(
                imageData,
                'jpn+eng', // 日本語と英語を認識
                { logger: m => console.log(m) }
            ).then(({ data: { text, lines } }) => {
                const textArray = text.split('\n').filter(line => line.trim().length > 0);
                
                // 行ごとのテキストを保存
                if (textId === 'text1') {
                    extractedTexts.text1 = textArray;
                    text1Div.innerHTML = textArray.map(line => `<p>${line}</p>`).join('');
                } else {
                    extractedTexts.text2 = textArray;
                    text2Div.innerHTML = textArray.map(line => `<p>${line}</p>`).join('');
                }
            });
        }

        // テキスト比較
        function compareTexts() {
            const text1 = extractedTexts.text1;
            const text2 = extractedTexts.text2;
            
            // 一致する行を検索
            const matchedLines = text1.filter(line => 
                text2.some(t2Line => 
                    line.trim().length > 3 && // 短すぎる行は除外
                    t2Line.trim().length > 3 && 
                    (t2Line.includes(line) || line.includes(t2Line))
                )
            );
            
            // 結果表示
            if (matchedLines.length > 0) {
                matchedTextDiv.innerHTML = matchedLines.map(line => 
                    `<div class="matched">${line}</div>`
                ).join('');
            } else {
                matchedTextDiv.innerHTML = "<p>一致するテキストが見つかりませんでした。</p>";
            }
        }

        // リセット機能
        function resetApp() {
            currentImageNum = 1;
            capturedImages = {
                photo1: null,
                photo2: null
            };
            extractedTexts = {
                text1: [],
                text2: []
            };
            
            photo1.src = "";
            photo2.src = "";
            text1Div.innerHTML = "";
            text2Div.innerHTML = "";
            matchedTextDiv.innerHTML = "";
            
            captureBtn.disabled = false;
            compareBtn.disabled = true;
        }

        // イベントリスナー
        captureBtn.addEventListener('click', captureImage);
        compareBtn.addEventListener('click', compareTexts);
        resetBtn.addEventListener('click', resetApp);

        // 初期化
        initCamera();
    </script>
</body>
</html>
