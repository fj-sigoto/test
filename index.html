<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>画像テキスト比較アプリ</title>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .image-container {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        .image-box {
            flex: 1;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 8px;
        }
        video, canvas, img {
            width: 100%;
            border-radius: 4px;
        }
        .overlay-container {
            position: relative;
            width: 100%;
        }
        .text-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        button:disabled {
            background-color: #cccccc;
        }
        #results {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            text-align: left;
        }
        .matched {
            background-color: #e6ffe6;
            padding: 5px;
            margin: 5px 0;
            border-radius: 4px;
        }
        .preprocessing-options {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
        }
        .preprocessing-options label {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .slider-container {
            display: flex;
            align-items: center;
            gap: 5px;
            margin: 5px 0;
        }
        .slider-container input {
            width: 100%;
        }
        .slider-value {
            width: 30px;
            text-align: right;
        }
        .tabs {
            display: flex;
            margin-bottom: 10px;
        }
        .tab {
            padding: 8px 16px;
            cursor: pointer;
            border: 1px solid #ccc;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            background-color: #f1f1f1;
        }
        .tab.active {
            background-color: white;
            border-bottom: 2px solid white;
        }
        .text-highlight {
            position: absolute;
            background-color: rgba(255, 255, 0, 0.3);
            border: 1px solid rgba(255, 200, 0, 0.8);
            border-radius: 2px;
        }
        .text-match-highlight {
            background-color: rgba(0, 255, 0, 0.3);
            border: 1px solid rgba(0, 200, 0, the0.8);
        }
        .overlay-controls {
            margin-top: 10px;
        }
        .word-highlight {
            position: absolute;
            background-color: rgba(255, 255, 0, 0.3);
            border: 1px solid rgba(255, 200, 0, 0.8);
            border-radius: 2px;
            padding: 2px;
            font-size: 12px;
            color: #000;
            pointer-events: none;
        }
        .word-text {
            position: absolute;
            font-size: 10px;
            color: #000;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 2px;
            border-radius: 2px;
            top: -18px;
            left: 0;
            white-space: nowrap;
        }
        .match-highlight {
            background-color: rgba(0, 255, 0, 0.4);
            border-color: rgba(0, 200, 0, 0.9);
        }
    </style>
</head>
<body>
    <h1>画像テキスト比較アプリ</h1>
    <div class="container">
        <div class="camera-container">
            <video id="video" autoplay playsinline></video>
        </div>
        
        <div>
            <button id="captureBtn">写真を撮影</button>
            <button id="compareBtn" disabled>テキストを比較</button>
            <button id="resetBtn">リセット</button>
        </div>
        
        <div class="preprocessing-options">
            <label>
                <input type="checkbox" id="enablePreprocessing" checked>
                前処理を有効にする
            </label>
            <label>
                <input type="checkbox" id="grayscale" checked>
                グレースケール
            </label>
            <label>
                <input type="checkbox" id="threshold" checked>
                二値化
            </label>
        </div>
        
        <div class="slider-container">
            <span>コントラスト:</span>
            <input type="range" id="contrast" min="0" max="200" value="120">
            <span id="contrastValue" class="slider-value">120</span>
        </div>
        
        <div class="slider-container">
            <span>明るさ:</span>
            <input type="range" id="brightness" min="0" max="200" value="110">
            <span id="brightnessValue" class="slider-value">110</span>
        </div>
        
        <div class="slider-container">
            <span>二値化閾値:</span>
            <input type="range" id="thresholdValue" min="0" max="255" value="128">
            <span id="thresholdValueDisplay" class="slider-value">128</span>
        </div>
        
        <div class="overlay-controls">
            <label>
                <input type="checkbox" id="showTextOverlay" checked>
                テキスト認識結果を表示
            </label>
        </div>
        
        <div class="tabs">
            <div id="origTab" class="tab active">元画像</div>
            <div id="processedTab" class="tab">処理後</div>
        </div>
        
        <div class="image-container" id="originalImages">
            <div class="image-box">
                <h3>画像 1</h3>
                <div class="overlay-container">
                    <img id="photo1" alt="撮影した画像1">
                    <div id="overlay1" class="text-overlay"></div>
                </div>
                <div id="text1"></div>
            </div>
            <div class="image-box">
                <h3>画像 2</h3>
                <div class="overlay-container">
                    <img id="photo2" alt="撮影した画像2">
                    <div id="overlay2" class="text-overlay"></div>
                </div>
                <div id="text2"></div>
            </div>
        </div>
        
        <div class="image-container" id="processedImages" style="display: none;">
            <div class="image-box">
                <h3>処理後画像 1</h3>
                <div class="overlay-container">
                    <img id="processed1" alt="処理後画像1">
                    <div id="processedOverlay1" class="text-overlay"></div>
                </div>
            </div>
            <div class="image-box">
                <h3>処理後画像 2</h3>
                <div class="overlay-container">
                    <img id="processed2" alt="処理後画像2">
                    <div id="processedOverlay2" class="text-overlay"></div>
                </div>
            </div>
        </div>
        
        <div id="results">
            <h3>一致したテキスト:</h3>
            <div id="matchedText"></div>
        </div>
    </div>

    <!-- Tesseract.js のインポート -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/2.1.5/tesseract.min.js"></script>
    
    <script>
        // 変数の初期化
        let currentImageNum = 1;
        let capturedImages = {
            photo1: null,
            photo2: null,
            processed1: null,
            processed2: null
        };
        let extractedTexts = {
            text1: [],
            text2: []
        };
        let recognizedWords = {
            image1: [],
            image2: []
        };
        let matchedTextList = [];
        
        // DOM要素
        const video = document.getElementById('video');
        const captureBtn = document.getElementById('captureBtn');
        const compareBtn = document.getElementById('compareBtn');
        const resetBtn = document.getElementById('resetBtn');
        const photo1 = document.getElementById('photo1');
        const photo2 = document.getElementById('photo2');
        const processed1 = document.getElementById('processed1');
        const processed2 = document.getElementById('processed2');
        const overlay1 = document.getElementById('overlay1');
        const overlay2 = document.getElementById('overlay2');
        const processedOverlay1 = document.getElementById('processedOverlay1');
        const processedOverlay2 = document.getElementById('processedOverlay2');
        const text1Div = document.getElementById('text1');
        const text2Div = document.getElementById('text2');
        const matchedTextDiv = document.getElementById('matchedText');
        const showTextOverlay = document.getElementById('showTextOverlay');
        
        // 前処理オプション
        const enablePreprocessing = document.getElementById('enablePreprocessing');
        const grayscaleOption = document.getElementById('grayscale');
        const thresholdOption = document.getElementById('threshold');
        const contrastSlider = document.getElementById('contrast');
        const brightnessSlider = document.getElementById('brightness');
        const thresholdSlider = document.getElementById('thresholdValue');
        const contrastValue = document.getElementById('contrastValue');
        const brightnessValue = document.getElementById('brightnessValue');
        const thresholdValueDisplay = document.getElementById('thresholdValueDisplay');
        
        // タブ
        const origTab = document.getElementById('origTab');
        const processedTab = document.getElementById('processedTab');
        const originalImages = document.getElementById('originalImages');
        const processedImages = document.getElementById('processedImages');
        
        // テキストオーバーレイの表示/非表示
        showTextOverlay.addEventListener('change', () => {
            if (showTextOverlay.checked) {
                overlay1.style.display = 'block';
                overlay2.style.display = 'block';
                processedOverlay1.style.display = 'block';
                processedOverlay2.style.display = 'block';
            } else {
                overlay1.style.display = 'none';
                overlay2.style.display = 'none';
                processedOverlay1.style.display = 'none';
                processedOverlay2.style.display = 'none';
            }
        });
        
        // スライダー値の表示を更新
        contrastSlider.addEventListener('input', () => {
            contrastValue.textContent = contrastSlider.value;
            updateProcessedImages();
        });
        
        brightnessSlider.addEventListener('input', () => {
            brightnessValue.textContent = brightnessSlider.value;
            updateProcessedImages();
        });
        
        thresholdSlider.addEventListener('input', () => {
            thresholdValueDisplay.textContent = thresholdSlider.value;
            updateProcessedImages();
        });
        
        // 前処理オプションの変更時に画像を更新
        enablePreprocessing.addEventListener('change', updateProcessedImages);
        grayscaleOption.addEventListener('change', updateProcessedImages);
        thresholdOption.addEventListener('change', updateProcessedImages);
        
        // タブの切り替え
        origTab.addEventListener('click', () => {
            origTab.classList.add('active');
            processedTab.classList.remove('active');
            originalImages.style.display = 'flex';
            processedImages.style.display = 'none';
        });
        
        processedTab.addEventListener('click', () => {
            processedTab.classList.add('active');
            origTab.classList.remove('active');
            processedImages.style.display = 'flex';
            originalImages.style.display = 'none';
        });

        // カメラを初期化
        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" },
                    audio: false 
                });
                video.srcObject = stream;
            } catch (err) {
                console.error("カメラへのアクセスに失敗しました:", err);
                alert("カメラへのアクセスに失敗しました。カメラの許可を確認してください。");
            }
        }

        // 画像をキャプチャ
        function captureImage() {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const imgData = canvas.toDataURL('image/png');
            
            if (currentImageNum === 1) {
                photo1.src = imgData;
                capturedImages.photo1 = imgData;
                text1Div.innerHTML = "<p>テキスト解析中...</p>";
                
                // 画像の前処理
                const processedImgData = preprocessImage(imgData);
                processed1.src = processedImgData;
                capturedImages.processed1 = processedImgData;
                
                // 前処理された画像からテキスト抽出
                if (enablePreprocessing.checked) {
                    extractTextWithLocation(processedImgData, 'text1', 'image1');
                } else {
                    extractTextWithLocation(imgData, 'text1', 'image1');
                }
                
                currentImageNum = 2;
            } else {
                photo2.src = imgData;
                capturedImages.photo2 = imgData;
                text2Div.innerHTML = "<p>テキスト解析中...</p>";
                
                // 画像の前処理
                const processedImgData = preprocessImage(imgData);
                processed2.src = processedImgData;
                capturedImages.processed2 = processedImgData;
                
                // 前処理された画像からテキスト抽出
                if (enablePreprocessing.checked) {
                    extractTextWithLocation(processedImgData, 'text2', 'image2');
                } else {
                    extractTextWithLocation(imgData, 'text2', 'image2');
                }
                
                // 比較ボタンを有効化
                captureBtn.disabled = true;
                compareBtn.disabled = false;
            }
        }
        
        // 前処理設定が変更された場合に画像を更新
        function updateProcessedImages() {
            if (capturedImages.photo1) {
                capturedImages.processed1 = preprocessImage(capturedImages.photo1);
                processed1.src = capturedImages.processed1;
            }
            
            if (capturedImages.photo2) {
                capturedImages.processed2 = preprocessImage(capturedImages.photo2);
                processed2.src = capturedImages.processed2;
            }
        }
        
        // 画像の前処理
        function preprocessImage(imageData) {
            // 前処理が無効なら元の画像を返す
            if (!enablePreprocessing.checked) {
                return imageData;
            }
            
            const img = new Image();
            img.src = imageData;
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = img.naturalWidth || 300;
            canvas.height = img.naturalHeight || 400;
            
            // 元の画像を描画
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            
            // ピクセルデータを取得
            const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imgData.data;
            
            const contrast = contrastSlider.value / 100;
            const brightness = brightnessSlider.value / 100;
            const thresholdValue = parseInt(thresholdSlider.value);
            
            // コントラストと明るさの調整
            for (let i = 0; i < data.length; i += 4) {
                // RGB値の取得
                let r = data[i];
                let g = data[i + 1];
                let b = data[i + 2];
                
                // グレースケール処理（必要な場合）
                if (grayscaleOption.checked) {
                    const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                    r = g = b = gray;
                }
                
                // コントラストと明るさの適用
                r = ((r / 255 - 0.5) * contrast + 0.5) * 255 * brightness;
                g = ((g / 255 - 0.5) * contrast + 0.5) * 255 * brightness;
                b = ((b / 255 - 0.5) * contrast + 0.5) * 255 * brightness;
                
                // 二値化（しきい値処理）
                if (thresholdOption.checked) {
                    const avg = (r + g + b) / 3;
                    r = g = b = avg > thresholdValue ? 255 : 0;
                }
                
                // 値の範囲を0-255に制限
                data[i] = Math.min(255, Math.max(0, r));
                data[i + 1] = Math.min(255, Math.max(0, g));
                data[i + 2] = Math.min(255, Math.max(0, b));
            }
            
            // 処理後の画像データをキャンバスに戻す
            ctx.putImageData(imgData, 0, 0);
            
            // 処理後の画像をデータURLとして返す
            return canvas.toDataURL('image/png');
        }

        // 位置情報付きでテキスト抽出
        function extractTextWithLocation(imageData, textId, imageId) {
            Tesseract.recognize(
                imageData,
                'jpn+eng', // 日本語と英語を認識
                { 
                    logger: m => console.log(m)
                }
            ).then(({ data }) => {
                // 認識されたテキストを行単位で保存
                const textArray = data.text.split('\n').filter(line => line.trim().length > 0);
                
                if (textId === 'text1') {
                    extractedTexts.text1 = textArray;
                    text1Div.innerHTML = textArray.map(line => `<p>${line}</p>`).join('');
                } else {
                    extractedTexts.text2 = textArray;
                    text2Div.innerHTML = textArray.map(line => `<p>${line}</p>`).join('');
                }
                
                // 単語レベルの位置情報を保存
                const words = [];
                
                data.words.forEach(word => {
                    if (word.text.trim().length > 0) {
                        words.push({
                            text: word.text,
                            bbox: {
                                x0: word.bbox.x0,
                                y0: word.bbox.y0,
                                x1: word.bbox.x1,
                                y1: word.bbox.y1
                            },
                            confidence: word.confidence
                        });
                    }
                });
                
                if (imageId === 'image1') {
                    recognizedWords.image1 = words;
                    // 単語のオーバーレイを表示
                    displayWordOverlays(words, overlay1, processedOverlay1);
                } else {
                    recognizedWords.image2 = words;
                    // 単語のオーバーレイを表示
                    displayWordOverlays(words, overlay2, processedOverlay2);
                }
            });
        }
        
        // 単語オーバーレイを表示
        function displayWordOverlays(words, overlayElement, processedOverlayElement) {
            // オーバーレイをクリア
            overlayElement.innerHTML = '';
            processedOverlayElement.innerHTML = '';
            
            // 画像のサイズを取得
            const imgWidth = overlayElement.parentElement.offsetWidth;
            const originalWidth = words.length > 0 ? Math.max(...words.map(w => w.bbox.x1)) : 0;
            
            // スケール係数を計算
            const scale = imgWidth / originalWidth;
            
            // 各単語に対してハイライト要素を作成
            words.forEach(word => {
                // 元画像用のオーバーレイ
                const highlightDiv = document.createElement('div');
                highlightDiv.className = 'word-highlight';
                
                // 位置を調整
                highlightDiv.style.left = (word.bbox.x0 * scale) + 'px';
                highlightDiv.style.top = (word.bbox.y0 * scale) + 'px';
                highlightDiv.style.width = ((word.bbox.x1 - word.bbox.x0) * scale) + 'px';
                highlightDiv.style.height = ((word.bbox.y1 - word.bbox.y0) * scale) + 'px';
                
                // テキストのラベルを追加
                const textLabel = document.createElement('div');
                textLabel.className = 'word-text';
                textLabel.textContent = word.text;
                highlightDiv.appendChild(textLabel);
                
                // データ属性に単語のテキストを設定（後で一致チェックに使用）
                highlightDiv.dataset.text = word.text;
                
                // オーバーレイに追加
                overlayElement.appendChild(highlightDiv);
                
                // 処理後画像用のオーバーレイ（同じものをコピー）
                const processedHighlightDiv = highlightDiv.cloneNode(true);
                processedOverlayElement.appendChild(processedHighlightDiv);
            });
        }

        // テキスト比較
        function compareTexts() {
            const text1 = extractedTexts.text1;
            const text2 = extractedTexts.text2;
            
            // 一致する行を検索
            matchedTextList = []; // リセット
            
            for (const line1 of text1) {
                if (line1.trim().length <= 3) continue; // 短すぎる行は除外
                
                for (const line2 of text2) {
                    if (line2.trim().length <= 3) continue; // 短すぎる行は除外
                    
                    // 完全一致
                    if (line1 === line2) {
                        if (!matchedTextList.includes(line1)) {
                            matchedTextList.push(line1);
                        }
                        continue;
                    }
                    
                    // 部分一致（一定の長さ以上の共通部分文字列を検出）
                    const minLength = Math.min(line1.length, line2.length);
                    const threshold = Math.max(4, Math.floor(minLength * 0.6)); // 最低4文字または60%以上の一致
                    
                    // 共通部分文字列を検索
                    let longestCommon = findLongestCommonSubstring(line1, line2);
                    if (longestCommon.length >= threshold) {
                        if (!matchedTextList.includes(line1)) {
                            matchedTextList.push(line1);
                        }
                    }
                }
            }
            
            // 結果表示
            if (matchedTextList.length > 0) {
                matchedTextDiv.innerHTML = matchedTextList.map(line => 
                    `<div class="matched">${line}</div>`
                ).join('');
                
                // ハイライト表示を更新
                highlightMatchedText();
            } else {
                matchedTextDiv.innerHTML = "<p>一致するテキストが見つかりませんでした。</p>";
            }
        }
        
        // 一致したテキストをハイライト表示
        function highlightMatchedText() {
            // 両方の画像のオーバーレイ内のすべての単語ハイライトをリセット
            const allHighlights = document.querySelectorAll('.word-highlight');
            allHighlights.forEach(highlight => {
                highlight.classList.remove('match-highlight');
            });
            
            // 一致するテキストを含む単語をハイライト
            matchedTextList.forEach(matchedText => {
                // 各単語に対して、その単語が一致テキストの一部かをチェック
                allHighlights.forEach(highlight => {
                    const wordText = highlight.dataset.text;
                    
                    // 単語が一致テキストに含まれているか、またはその逆をチェック
                    if ((matchedText.includes(wordText) || wordText.includes(matchedText)) && 
                        wordText.length > 1) { // 単一文字は除外
                        highlight.classList.add('match-highlight');
                    }
                });
            });
        }
        
        // 最長共通部分文字列を見つける関数
        function findLongestCommonSubstring(str1, str2) {
            if (!str1 || !str2) {
                return '';
            }
            
            let longestSubstring = '';
            const str1Length = str1.length;
            const str2Length = str2.length;
            
            // 動的計画法を使用して最長共通部分文字列を見つける
            const dp = Array(str1Length + 1).fill().map(() => Array(str2Length + 1).fill(0));
            
            for (let i = 1; i <= str1Length; i++) {
                for (let j = 1; j <= str2Length; j++) {
                    if (str1[i - 1] === str2[j - 1]) {
                        dp[i][j] = dp[i - 1][j - 1] + 1;
                        
                        if (dp[i][j] > longestSubstring.length) {
                            longestSubstring = str1.substring(i - dp[i][j], i);
                        }
                    }
                }
            }
            
            return longestSubstring;
        }

        // リセット機能
        function resetApp() {
            currentImageNum = 1;
            capturedImages = {
                photo1: null,
                photo2: null,
                processed1: null,
                processed2: null
            };
            extractedTexts = {
                text1: [],
                text2: []
            };
            recognizedWords = {
                image1: [],
                image2: []
            };
            matchedTextList = [];
            
            photo1.src = "";
            photo2.src = "";
            processed1.src = "";
            processed2.src = "";
            text1Div.innerHTML = "";
            text2Div.innerHTML = "";
            matchedTextDiv.innerHTML = "";
            overlay1.innerHTML = "";
            overlay2.innerHTML = "";
            processedOverlay1.innerHTML = "";
            processedOverlay2.innerHTML = "";
            
            captureBtn.disabled = false;
            compareBtn.disabled = true;
            
            // タブをリセット
            origTab.click();
        }

        // イベントリスナー
        captureBtn.addEventListener('click', captureImage);
        compareBtn.addEventListener('click', compareTexts);
        resetBtn.addEventListener('click', resetApp);

        // 初期化
        initCamera();
    </script>
</body>
</html>
